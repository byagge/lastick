<!DOCTYPE html>
<html lang="ru" x-data="settingsPage()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0e121a">
    <title>Smart Factory - Настройки</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 55%, #e5e7eb 100%); }
        .card { box-shadow: 0 2px 12px 0 rgba(15,23,42,0.08); }
        .toggle-bg { transition: background-color 0.2s ease; }
        .toggle-dot { transition: transform 0.2s ease; }
        .accent-bg { background-color: #0e121a; }
        .accent-text { color: #0e121a; }
        .accent-ring:focus { box-shadow: 0 0 0 2px rgba(14, 18, 26, 0.2); }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
    <header class="fixed top-0 left-0 right-0 z-20 bg-white/90 backdrop-blur border-b border-gray-200 flex items-center justify-between px-4 h-16">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 accent-bg rounded-xl flex items-center justify-center">
                <span class="text-white font-bold text-2xl">S</span>
            </div>
            <span class="text-lg font-semibold text-gray-900">Настройки</span>
        </div>
        <button class="text-gray-600 hover:text-gray-900" title="Уведомления">
            <i data-lucide="bell" class="w-6 h-6"></i>
        </button>
    </header>

    <main class="flex-1 pt-20 pb-10 px-4 max-w-md mx-auto w-full">
        <div class="card bg-white rounded-2xl p-4 mb-5">
            <div class="flex items-center space-x-4">
                <div class="w-14 h-14 rounded-full bg-gradient-to-r from-gray-900 to-gray-700 flex items-center justify-center text-white text-lg font-bold">
                    <span x-text="profile.initials"></span>
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-900" x-text="profile.name"></div>
                    <div class="text-sm text-gray-500" x-text="profile.role"></div>
                </div>
                <button class="px-3 py-2 text-sm rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50">
                    Редактировать
                </button>
            </div>
        </div>

        <div class="card bg-white rounded-2xl p-4 mb-5 opacity-60 pointer-events-none">
            <h2 class="text-sm font-semibold text-gray-900 mb-3">Безопасность</h2>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-900">Вход по PIN</div>
                        <div class="text-xs text-gray-500">Быстрый вход</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only" x-model="settings.pin_login" disabled>
                        <div class="w-11 h-6 bg-gray-200 rounded-full toggle-bg" :class="settings.pin_login ? 'bg-gray-900' : 'bg-gray-200'"></div>
                        <div class="w-5 h-5 bg-white rounded-full shadow toggle-dot absolute left-0.5 top-0.5" :style="settings.pin_login ? 'transform: translateX(20px);' : 'transform: translateX(0);'"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-900">Face ID</div>
                        <div class="text-xs text-gray-500">Если поддерживается устройством</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only" x-model="settings.face_id" disabled>
                        <div class="w-11 h-6 bg-gray-200 rounded-full toggle-bg" :class="settings.face_id ? 'bg-gray-900' : 'bg-gray-200'"></div>
                        <div class="w-5 h-5 bg-white rounded-full shadow toggle-dot absolute left-0.5 top-0.5" :style="settings.face_id ? 'transform: translateX(20px);' : 'transform: translateX(0);'"></div>
                    </label>
                </div>
                <button class="w-full px-4 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50">
                    Сменить пароль
                </button>
            </div>
        </div>

        <div class="space-y-3">
            <button @click="saveSettings()" class="w-full px-4 py-3 rounded-xl accent-bg text-white font-semibold">
                Сохранить изменения
            </button>
            <button @click="resetSettings()" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-gray-700">
                Сбросить настройки
            </button>
            <button class="w-full px-4 py-3 rounded-xl border border-red-200 text-red-600">
                Выйти из аккаунта
            </button>
            <div x-show="saveMessage" class="text-center text-sm text-green-600" x-text="saveMessage"></div>
        </div>
    </main>

    <script>
        function settingsPage() {
            return {
                profile: {
                    name: 'Сотрудник',
                    role: 'Производство',
                    initials: 'С'
                },
                settings: {
                    pin_login: false,
                    face_id: false
                },
                saveMessage: '',
                init() {
                    this.fetchSettings();
                    lucide.createIcons();
                },
                async fetchSettings() {
                    try {
                        const resp = await fetch('/accounts/api/settings/');
                        if (!resp.ok) return;
                        const data = await resp.json();
                        if (data.profile) {
                            this.profile = {
                                name: data.profile.name || this.profile.name,
                                role: data.profile.role || this.profile.role,
                                initials: data.profile.initials || this.profile.initials
                            };
                        }
                        if (data.settings) {
                            this.settings = {
                                pin_login: !!data.settings.pin_login,
                                face_id: !!data.settings.face_id
                            };
                        }
                    } catch (e) {}
                },
                async saveSettings() {
                    try {
                        const resp = await fetch('/accounts/api/settings/', {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(this.settings)
                        });
                        if (resp.ok) {
                            this.saveMessage = 'Настройки сохранены.';
                        } else {
                            this.saveMessage = 'Не удалось сохранить.';
                        }
                    } catch (e) {
                        this.saveMessage = 'Не удалось сохранить.';
                    }
                    setTimeout(() => {
                        this.saveMessage = '';
                    }, 2000);
                },
                resetSettings() {
                    this.settings = {
                        pin_login: false,
                        face_id: false
                    };
                    this.saveMessage = 'Настройки сброшены.';
                    setTimeout(() => {
                        this.saveMessage = '';
                    }, 2000);
                },
                getCsrfToken() {
                    const name = 'csrftoken';
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + '=')) {
                            return decodeURIComponent(cookie.substring(name.length + 1));
                        }
                    }
                    return '';
                }
            };
        }
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>
