<!DOCTYPE html>
<html lang="ru" x-data="finishedGoodsMobile()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0e121a">
    <title>Smart Factory - Готовая продукция</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 55%, #e5e7eb 100%); }
        .nav-active { color: #0e121a; }
        .nav-bar { box-shadow: 0 -2px 16px 0 rgba(15,23,42,0.1); }
        .card { box-shadow: 0 2px 12px 0 rgba(15,23,42,0.08); }
        .modal-bg { background: rgba(0,0,0,0.35); }
        .skeleton { background: linear-gradient(90deg, #e0e7ef 25%, #f3f4f6 50%, #e0e7ef 75%); background-size: 200% 100%; animation: skeleton 1.2s infinite linear; }
        @keyframes skeleton { 0% {background-position: 200% 0;} 100% {background-position: -200% 0;} }
        .bg-blue-600 { background-color: #0e121a !important; }
        .text-blue-600 { color: #0e121a !important; }
        .bg-blue-100 { background-color: #e2e8f0 !important; }
        .bg-blue-50 { background-color: #f1f5f9 !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
    <header class="fixed top-0 left-0 right-0 z-20 bg-white/90 backdrop-blur border-b border-gray-200 flex items-center justify-between px-4 h-16">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                <span class="text-white font-bold text-2xl">S</span>
            </div>
            <span class="text-lg font-semibold text-gray-900">Готовая продукция</span>
        </div>
    </header>

    <main class="flex-1 pt-20 pb-20 px-4 max-w-md mx-auto w-full">
        <div class="flex items-center gap-2 mb-4">
            <button @click="activeSection = 'stock'" :class="activeSection === 'stock' ? 'bg-gray-900 text-white' : 'bg-white border border-gray-200 text-gray-600'" class="px-3 py-2 rounded-lg text-sm">Склад</button>
            <button @click="activeSection = 'sales'" :class="activeSection === 'sales' ? 'bg-gray-900 text-white' : 'bg-white border border-gray-200 text-gray-600'" class="px-3 py-2 rounded-lg text-sm">Продажи</button>
        </div>

        <div class="relative mb-6" x-show="activeSection === 'stock'">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
            <input type="text" placeholder="Поиск по продукту, заказу, получателю..." x-model="searchTerm" class="w-full pl-10 pr-4 py-3 bg-white rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <template x-if="loading && activeSection === 'stock'">
            <div class="space-y-4 animate-pulse">
                <div class="h-20 rounded-xl skeleton"></div>
                <div class="h-20 rounded-xl skeleton"></div>
                <div class="h-20 rounded-xl skeleton"></div>
            </div>
        </template>

        <template x-if="!loading && activeSection === 'stock'">
            <div>
                <template x-if="filteredGoods().length === 0">
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="package" class="w-10 h-10 text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Готовая продукция не найдена</h3>
                        <p class="text-gray-600">Измените фильтры или поисковый запрос.</p>
                    </div>
                </template>
                <template x-for="good in filteredGoods()" :key="good.id">
                    <div class="card bg-white rounded-xl p-4 mb-4 cursor-pointer" @click="openDetailPanel(good.id)">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h3 class="font-semibold text-gray-900 text-base" x-text="getProductName(good)"></h3>
                                <p class="text-xs text-gray-500" x-text="getOrderName(good) || 'Без заказа'"></p>
                            </div>
                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold" :class="good.status === 'issued' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'" x-text="good.status_display"></span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                            <div><span class="text-gray-400">Количество:</span> <span class="font-medium text-gray-700" x-text="good.quantity"></span></div>
                            <div><span class="text-gray-400">Принято:</span> <span class="font-medium text-gray-700" x-text="formatDate(good.received_at)"></span></div>
                            <div><span class="text-gray-400">Выдано:</span> <span class="font-medium text-gray-700" x-text="formatDate(good.issued_at)"></span></div>
                            <div><span class="text-gray-400">Получатель:</span> <span class="font-medium text-gray-700" x-text="good.recipient || '-' "></span></div>
                        </div>
                        <div class="mt-2 text-xs text-gray-400" x-text="good.comment || '-' "></div>
                        <button class="mt-3 w-full px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50" @click.stop="prepareSale(good)" :disabled="good.status === 'issued'">Продать</button>
                    </div>
                </template>
            </div>
        </template>

        <template x-if="showDetailPanel && activeSection === 'stock'">
            <div class="fixed inset-0 z-50">
                <div class="absolute inset-0 modal-bg" @click="closeDetailPanel()"></div>
                <div class="fixed right-0 top-0 h-full w-full max-w-md bg-white rounded-l-2xl p-6 overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Детали партии</h2>
                            <p class="text-xs text-gray-500" x-text="detailGood ? getProductName(detailGood) : ''"></p>
                        </div>
                        <button @click="closeDetailPanel()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                            <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                        </button>
                    </div>

                    <template x-if="detailLoading">
                        <div class="text-center py-8 text-gray-400">Загрузка...</div>
                    </template>

                    <template x-if="!detailLoading && detailGood">
                        <div class="space-y-4">
                            <div class="bg-gray-50 rounded-xl p-4 text-sm">
                                <div class="flex justify-between"><span class="text-gray-500">Количество</span><span x-text="detailGood.quantity"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Статус</span><span x-text="detailGood.status_display"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Получатель</span><span x-text="detailGood.recipient || '-' "></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Принято</span><span x-text="formatDate(detailGood.received_at)"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Выдано</span><span x-text="formatDate(detailGood.issued_at)"></span></div>
                                <div class="mt-2"><span class="text-gray-500">Комментарий</span><div class="text-gray-900" x-text="detailGood.comment || '-' "></div></div>
                            </div>

                            <div class="border border-gray-200 rounded-xl p-4 text-sm">
                                <h3 class="font-semibold text-gray-900 mb-2">Продукт</h3>
                                <template x-if="detailGood.product">
                                    <div class="space-y-1">
                                        <div><span class="text-gray-500">Название:</span> <span x-text="detailGood.product.name"></span></div>
                                        <div><span class="text-gray-500">Тип:</span> <span x-text="detailGood.product.type"></span></div>
                                        <div><span class="text-gray-500">Описание:</span> <span x-text="detailGood.product.description || '-' "></span></div>
                                    </div>
                                </template>
                                <template x-if="!detailGood.product">
                                    <div class="text-gray-500">Нет данных о продукте.</div>
                                </template>
                            </div>

                            <div class="border border-gray-200 rounded-xl p-4 text-sm">
                                <h3 class="font-semibold text-gray-900 mb-2">Заказ</h3>
                                <template x-if="detailGood.order">
                                    <div class="space-y-1">
                                        <div><span class="text-gray-500">Название:</span> <span x-text="detailGood.order.name || detailGood.order"></span></div>
                                        <div><span class="text-gray-500">Статус:</span> <span x-text="detailGood.order.status"></span></div>
                                        <div><span class="text-gray-500">Комментарий:</span> <span x-text="detailGood.order.comment || '-' "></span></div>
                                    </div>
                                </template>
                                <template x-if="!detailGood.order">
                                    <div class="text-gray-500">Нет данных о заказе.</div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <template x-if="activeSection === 'sales'">
            <div class="space-y-4">
                <div class="bg-white rounded-xl border border-gray-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="text-base font-semibold text-gray-900">Продажи</h3>
                            <p class="text-xs text-gray-500">Все продажи готовой продукции.</p>
                        </div>
                        <button class="text-xs px-2 py-1 border border-gray-200 rounded-lg" @click="fetchSales()">Обновить</button>
                    </div>
                    <template x-if="sales.length === 0">
                        <div class="text-center py-8 text-gray-500">Продаж пока нет.</div>
                    </template>
                    <template x-for="sale in sales" :key="sale.id">
                        <div class="border border-gray-100 rounded-lg p-3 mb-3">
                            <div class="flex justify-between text-sm font-medium text-gray-900">
                                <span x-text="sale.product_name || '-' "></span>
                                <span x-text="formatMoney(sale.price)"></span>
                            </div>
                            <div class="mt-1 text-xs text-gray-500">
                                <span x-text="sale.client_name || '-' "></span>
                                <span class="mx-1">•</span>
                                <span x-text="sale.order_name || 'Без заказа'"></span>
                            </div>
                            <div class="mt-1 text-xs text-gray-400" x-text="formatDate(sale.sold_at)"></div>
                        </div>
                    </template>
                </div>

                <div class="bg-white rounded-xl border border-gray-200 p-4">
                    <h3 class="text-base font-semibold text-gray-900 mb-2">Оформить продажу</h3>
                    <form class="space-y-3" @submit.prevent="submitSale()">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Товар со склада</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="saleForm.good_label" readonly placeholder="Товар не выбран" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-sm bg-gray-50">
                                <button type="button" class="px-3 py-2 text-sm border border-gray-200 rounded-lg" @click="openPicker('good')">Выбрать</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Клиент</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="saleForm.client_label" readonly placeholder="Клиент не выбран" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-sm bg-gray-50">
                                <button type="button" class="px-3 py-2 text-sm border border-gray-200 rounded-lg" @click="openPicker('client')">Выбрать</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Заказ (необязательно)</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="saleForm.order_label" readonly placeholder="Без заказа" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-sm bg-gray-50">
                                <button type="button" class="px-3 py-2 text-sm border border-gray-200 rounded-lg" @click="openPicker('order')">Выбрать</button>
                                <button type="button" class="px-3 py-2 text-sm border border-gray-200 rounded-lg" @click="clearOrder()">Очистить</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Цена продажи</label>
                            <input type="number" step="0.01" x-model="saleForm.price" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="Введите цену">
                        </div>
                        <div x-show="saleError" class="text-xs text-red-600" x-text="saleError"></div>
                        <div x-show="saleSuccess" class="text-xs text-green-600" x-text="saleSuccess"></div>
                        <button type="submit" class="w-full px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">Оформить продажу</button>
                    </form>
                </div>
            </div>
        </template>

        <div x-show="pickerOpen" class="fixed inset-0 z-50" style="display: none;">
            <div class="absolute inset-0 modal-bg" @click="closePicker()"></div>
            <div class="fixed right-0 top-0 h-full w-full max-w-md bg-white rounded-l-2xl p-4 overflow-y-auto">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h3 class="text-base font-semibold text-gray-900" x-text="pickerTitle"></h3>
                        <p class="text-xs text-gray-500">Введите для поиска и выберите вариант.</p>
                    </div>
                    <button @click="closePicker()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                    </button>
                </div>
                <div class="relative mb-3">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <input type="text" x-model="pickerSearch" @input.debounce.300ms="loadPickerResults()" placeholder="Поиск..." class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <template x-if="pickerLoading">
                    <div class="text-center py-6 text-gray-400 text-sm">Загрузка...</div>
                </template>
                <template x-if="!pickerLoading">
                    <div class="space-y-2">
                        <template x-for="item in pickerResults" :key="item.id">
                            <button type="button" class="w-full text-left border border-gray-200 rounded-lg px-3 py-2" @click="selectPickerItem(item)">
                                <div class="text-sm font-medium text-gray-900" x-text="item.title"></div>
                                <div class="text-xs text-gray-500" x-text="item.subtitle"></div>
                            </button>
                        </template>
                        <div x-show="pickerResults.length === 0" class="text-center text-xs text-gray-400 py-6">Ничего не найдено.</div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    {% include 'partials/bottom_nav_mobile.html' %}

    <script>
        function finishedGoodsMobile() {
            return {
                loading: true,
                goods: [],
                sales: [],
                searchTerm: '',
                activeSection: 'stock',
                showDetailPanel: false,
                detailGood: null,
                detailLoading: false,
                saleForm: {
                    finished_good_id: '',
                    good_label: '',
                    client_id: '',
                    client_label: '',
                    order_id: '',
                    order_label: '',
                    price: ''
                },
                saleError: '',
                saleSuccess: '',
                pickerOpen: false,
                pickerType: '',
                pickerTitle: '',
                pickerSearch: '',
                pickerResults: [],
                pickerLoading: false,
                async fetchGoods() {
                    const resp = await fetch('/finished_goods/api/finished_goods/');
                    const data = await resp.json();
                    this.goods = Array.isArray(data) ? data : (data.results || []);
                },
                async fetchSales() {
                    const resp = await fetch('/finished_goods/api/sales/');
                    const data = await resp.json();
                    this.sales = Array.isArray(data) ? data : (data.results || []);
                },
                stockGoods() {
                    return this.goods.filter(good => good.status === 'stock');
                },
                prepareSale(good) {
                    if (!good || good.status === 'issued') return;
                    this.saleForm.finished_good_id = String(good.id);
                    this.saleForm.good_label = `${this.getProductName(good)} (ID ${good.id})`;
                    this.activeSection = 'sales';
                    this.saleError = '';
                    this.saleSuccess = '';
                },
                clearOrder() {
                    this.saleForm.order_id = '';
                    this.saleForm.order_label = '';
                },
                openPicker(type) {
                    this.pickerType = type;
                    this.pickerTitle = type === 'good' ? 'Выбор товара' : (type === 'client' ? 'Выбор клиента' : 'Выбор заказа');
                    this.pickerSearch = '';
                    this.pickerResults = [];
                    this.pickerOpen = true;
                    this.loadPickerResults();
                    this.$nextTick(() => lucide.createIcons());
                },
                closePicker() {
                    this.pickerOpen = false;
                },
                async loadPickerResults() {
                    const term = this.pickerSearch.trim().toLowerCase();
                    this.pickerLoading = true;
                    if (this.pickerType === 'good') {
                        const goods = this.stockGoods().filter(good => {
                            const name = this.getProductName(good).toLowerCase();
                            return !term || name.includes(term) || String(good.id).includes(term);
                        }).slice(0, 30);
                        this.pickerResults = goods.map(good => ({
                            id: good.id,
                            title: `${this.getProductName(good)} (ID ${good.id})`,
                            subtitle: `Количество: ${good.quantity}`
                        }));
                        this.pickerLoading = false;
                        return;
                    }
                    const baseUrl = this.pickerType === 'client'
                        ? '/clients/api/clients/'
                        : '/orders/api/orders/';
                    const url = `${baseUrl}?search=${encodeURIComponent(term)}&page_size=20`;
                    try {
                        const resp = await fetch(url);
                        const data = await resp.json();
                        const results = Array.isArray(data) ? data : (data.results || []);
                        if (this.pickerType === 'client') {
                            this.pickerResults = results.map(client => ({
                                id: client.id,
                                title: client.name,
                                subtitle: client.company || client.phone || client.email || ''
                            }));
                        } else {
                            this.pickerResults = results.map(order => ({
                                id: order.id,
                                title: order.name,
                                subtitle: order.client && order.client.name ? order.client.name : ''
                            }));
                        }
                    } catch (e) {
                        this.pickerResults = [];
                    }
                    this.pickerLoading = false;
                },
                selectPickerItem(item) {
                    if (this.pickerType === 'good') {
                        this.saleForm.finished_good_id = String(item.id);
                        this.saleForm.good_label = item.title;
                    } else if (this.pickerType === 'client') {
                        this.saleForm.client_id = String(item.id);
                        this.saleForm.client_label = item.title;
                    } else if (this.pickerType === 'order') {
                        this.saleForm.order_id = String(item.id);
                        this.saleForm.order_label = item.title;
                    }
                    this.closePicker();
                },
                async submitSale() {
                    this.saleError = '';
                    this.saleSuccess = '';
                    if (!this.saleForm.finished_good_id || !this.saleForm.client_id || !this.saleForm.price) {
                        this.saleError = 'Заполните товар, клиента и цену.';
                        return;
                    }
                    const payload = {
                        finished_good_id: this.saleForm.finished_good_id,
                        client_id: this.saleForm.client_id,
                        price: this.saleForm.price
                    };
                    if (this.saleForm.order_id) {
                        payload.order_id = this.saleForm.order_id;
                    }
                    const resp = await fetch('/finished_goods/api/sales/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) {
                        this.saleError = 'Не удалось оформить продажу.';
                        return;
                    }
                    this.saleForm = { finished_good_id: '', good_label: '', client_id: '', client_label: '', order_id: '', order_label: '', price: '' };
                    this.saleSuccess = 'Продажа сохранена.';
                    await this.fetchSales();
                    await this.fetchGoods();
                    this.$nextTick(() => lucide.createIcons());
                },
                getProductName(good) {
                    if (!good) return '';
                    if (typeof good.product === 'string') return good.product;
                    return good.product && good.product.name ? good.product.name : '';
                },
                getOrderName(good) {
                    if (!good) return '';
                    if (typeof good.order === 'string') return good.order;
                    return good.order && good.order.name ? good.order.name : '';
                },
                formatDate(value) {
                    if (!value) return '-';
                    try {
                        return new Date(value).toLocaleString('ru-RU');
                    } catch (e) {
                        return '-';
                    }
                },
                formatMoney(value) {
                    if (value === null || value === undefined || value === '') return '-';
                    const amount = Number(value);
                    if (Number.isNaN(amount)) return '-';
                    return `${amount.toLocaleString('ru-RU')} сом`;
                },
                filteredGoods() {
                    const term = this.searchTerm.toLowerCase();
                    return this.goods.filter(good => {
                        const product = this.getProductName(good).toLowerCase();
                        const order = this.getOrderName(good).toLowerCase();
                        const recipient = (good.recipient || '').toLowerCase();
                        const comment = (good.comment || '').toLowerCase();
                        return product.includes(term) || order.includes(term) || recipient.includes(term) || comment.includes(term);
                    });
                },
                async init() {
                    await this.fetchGoods();
                    await this.fetchSales();
                    this.loading = false;
                    this.$nextTick(() => lucide.createIcons());
                },
                getCsrfToken() {
                    const name = 'csrftoken';
                    const cookies = document.cookie ? document.cookie.split(';') : [];
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === `${name}=`) {
                            return decodeURIComponent(cookie.substring(name.length + 1));
                        }
                    }
                    return '';
                },
                async openDetailPanel(id) {
                    this.showDetailPanel = true;
                    this.detailLoading = true;
                    this.detailGood = null;
                    try {
                        const resp = await fetch(`/finished_goods/api/finished_goods/${id}/`);
                        this.detailGood = await resp.json();
                    } catch (e) {
                        this.detailGood = null;
                    }
                    this.detailLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                },
                closeDetailPanel() {
                    this.showDetailPanel = false;
                    this.detailGood = null;
                    this.detailLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>
