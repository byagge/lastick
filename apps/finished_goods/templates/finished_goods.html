<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Factory - Готовая продукция</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 55%, #e5e7eb 100%); }
        .glass { background: rgba(255,255,255,0.78); backdrop-filter: blur(12px); }
        .card { box-shadow: 0 2px 14px 0 rgba(15, 23, 42, 0.06); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #e0e7ef; border-radius: 4px; }
        aside::-webkit-scrollbar { display: none; }
        .bg-blue-600 { background-color: #0e121a !important; }
        .hover\:bg-blue-700:hover { background-color: #0b0f16 !important; }
        .text-blue-600 { color: #0e121a !important; }
        .bg-blue-100 { background-color: #e2e8f0 !important; }
        .bg-blue-50 { background-color: #f1f5f9 !important; }
    </style>
</head>
<body class="min-h-screen">
    {% include 'partials/app_header.html' %}
    {% include 'partials/app_sidebar.html' %}

    <main class="flex-1 overflow-auto ml-64 p-6 pt-28" x-data="finishedGoodsData()" x-init="init()">
        <div class="glass rounded-xl border border-gray-200 p-6 mb-6 flex flex-col lg:flex-row lg:items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Готовая продукция</h1>
                <p class="text-gray-600">Контроль остатков, выдачи и статусов готовых товаров.</p>
                <div class="mt-4 flex flex-wrap items-center gap-2">
                    <button @click="activeSection = 'stock'" :class="activeSection === 'stock' ? 'bg-gray-900 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'" class="px-3 py-2 rounded-lg text-sm">Склад</button>
                    <button @click="activeSection = 'sales'" :class="activeSection === 'sales' ? 'bg-gray-900 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'" class="px-3 py-2 rounded-lg text-sm">Продажи</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3 mt-4 lg:mt-0" x-show="activeSection === 'stock'">
                <button @click="viewMode = 'table'" :class="viewMode === 'table' ? 'bg-gray-900 text-white border-gray-900' : 'border border-gray-300 text-gray-600 hover:bg-gray-50'" class="px-3 py-2 rounded-lg text-sm flex items-center space-x-1">
                    <i data-lucide="list" class="w-4 h-4"></i>
                    <span>Список</span>
                </button>
                <button @click="viewMode = 'cards'" :class="viewMode === 'cards' ? 'bg-gray-900 text-white border-gray-900' : 'border border-gray-300 text-gray-600 hover:bg-gray-50'" class="px-3 py-2 rounded-lg text-sm flex items-center space-x-1">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                    <span>Карточки</span>
                </button>
            </div>
        </div>

        <div x-show="activeSection === 'stock'">
        <div class="flex flex-col lg:flex-row gap-4 items-center justify-between mb-6">
            <div class="relative w-full lg:w-96">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                <input type="text" placeholder="Поиск по продукту, заказу, получателю..." x-model="searchTerm" class="pl-10 pr-4 py-3 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            </div>
        </div>

        <div x-show="viewMode === 'table'" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <template x-for="column in columns" :key="column">
                                <th class="px-4 py-3 text-left font-medium text-gray-900 cursor-pointer hover:bg-gray-100" @click="handleSort(column)">
                                    <div class="flex items-center space-x-2">
                                        <span x-text="columnLabels[column]"></span>
                                        <template x-if="sortField === column">
                                            <i :data-lucide="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'" style="width: 16px; height: 16px;"></i>
                                        </template>
                                    </div>
                                </th>
                            </template>
                            <th class="px-4 py-3 text-left font-medium text-gray-900">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="good in filteredGoods()" :key="good.id">
                            <tr @click="openDetailPanel(good.id)" class="cursor-pointer hover:bg-blue-50">
                                <td class="px-4 py-3" x-text="getProductName(good)"></td>
                                <td class="px-4 py-3" x-text="good.quantity"></td>
                                <td class="px-4 py-3" x-text="getOrderName(good)"></td>
                                <td class="px-4 py-3">
                                    <span :class="good.status === 'issued' ? 'text-green-600 font-semibold' : 'text-blue-600 font-semibold'" x-text="good.status_display"></span>
                                </td>
                                <td class="px-4 py-3" x-text="formatDate(good.received_at)"></td>
                                <td class="px-4 py-3" x-text="formatDate(good.issued_at)"></td>
                                <td class="px-4 py-3" x-text="good.recipient || '-' "></td>
                                <td class="px-4 py-3" x-text="good.comment || '-' "></td>
                                <td class="px-4 py-3">
                                    <button class="px-3 py-1 text-sm rounded-lg border border-gray-200 hover:bg-gray-50" @click.stop="prepareSale(good)" :disabled="good.status === 'issued'">
                                        Продать
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div x-show="filteredGoods().length === 0" class="text-center py-12">
                <i data-lucide="package" class="mx-auto text-gray-400 mb-4" style="width: 48px; height: 48px;"></i>
                <p class="text-gray-500 text-lg">Готовая продукция не найдена</p>
                <p class="text-gray-400">Измените фильтры или поисковый запрос.</p>
            </div>
        </div>

        <div x-show="viewMode === 'cards'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="good in filteredGoods()" :key="good.id">
                <div class="card bg-white/90 backdrop-blur rounded-xl border border-gray-200 p-4 relative overflow-hidden">
                    <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-gray-900 via-gray-700 to-gray-500"></div>
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-900" x-text="getProductName(good)"></h3>
                            <p class="text-sm text-gray-500" x-text="getOrderName(good) || 'Без заказа'"></p>
                        </div>
                        <span class="inline-block px-2 py-1 rounded text-xs font-semibold" :class="good.status === 'issued' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'" x-text="good.status_display"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">Количество:</span>
                            <p class="font-medium" x-text="good.quantity"></p>
                        </div>
                        <div>
                            <span class="text-gray-600">Получатель:</span>
                            <p class="font-medium" x-text="good.recipient || '-' "></p>
                        </div>
                        <div>
                            <span class="text-gray-600">Принято:</span>
                            <p class="font-medium" x-text="formatDate(good.received_at)"></p>
                        </div>
                        <div>
                            <span class="text-gray-600">Выдано:</span>
                            <p class="font-medium" x-text="formatDate(good.issued_at)"></p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 text-sm">
                        <span class="text-gray-600">Комментарий:</span>
                        <span class="font-medium" x-text="good.comment || '-' "></span>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button @click="openDetailPanel(good.id)" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Подробнее</button>
                        <button @click="prepareSale(good)" class="w-full px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50" :disabled="good.status === 'issued'">Продать</button>
                    </div>
                </div>
            </template>
            <div x-show="filteredGoods().length === 0" class="col-span-full text-center py-12">
                <i data-lucide="package" class="mx-auto text-gray-400 mb-4" style="width: 48px; height: 48px;"></i>
                <p class="text-gray-500 text-lg">Готовая продукция не найдена</p>
                <p class="text-gray-400">Измените фильтры или поисковый запрос.</p>
            </div>
        </div>

        <div x-show="showDetailPanel" class="fixed inset-0 z-50" style="display: none;">
            <div class="absolute inset-0 bg-black bg-opacity-40" @click="closeDetailPanel()"></div>
            <aside class="fixed right-0 top-0 h-full w-full max-w-xl bg-white shadow-xl p-6 overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Детали партии</h2>
                        <p class="text-sm text-gray-500" x-text="detailGood ? getProductName(detailGood) : ''"></p>
                    </div>
                    <button @click="closeDetailPanel()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <template x-if="detailLoading">
                    <div class="text-center py-8 text-gray-400">Загрузка...</div>
                </template>

                <template x-if="!detailLoading && detailGood">
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h3 class="font-semibold text-gray-900 mb-3">Основное</h3>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div><span class="text-gray-600">ID:</span> <span x-text="detailGood.id"></span></div>
                                <div><span class="text-gray-600">Количество:</span> <span x-text="detailGood.quantity"></span></div>
                                <div><span class="text-gray-600">Статус:</span> <span x-text="detailGood.status_display"></span></div>
                                <div><span class="text-gray-600">Получатель:</span> <span x-text="detailGood.recipient || '-' "></span></div>
                                <div><span class="text-gray-600">Принято:</span> <span x-text="formatDate(detailGood.received_at)"></span></div>
                                <div><span class="text-gray-600">Выдано:</span> <span x-text="formatDate(detailGood.issued_at)"></span></div>
                                <div class="col-span-2"><span class="text-gray-600">Комментарий:</span> <span x-text="detailGood.comment || '-' "></span></div>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-xl p-4">
                            <h3 class="font-semibold text-gray-900 mb-3">Продукт</h3>
                            <template x-if="detailGood.product">
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-600">Название:</span> <span x-text="detailGood.product.name"></span></div>
                                    <div><span class="text-gray-600">Тип:</span> <span x-text="detailGood.product.type"></span></div>
                                    <div><span class="text-gray-600">Описание:</span> <span x-text="detailGood.product.description || '-' "></span></div>
                                    <div><span class="text-gray-600">Цена:</span> <span x-text="detailGood.product.price"></span></div>
                                </div>
                            </template>
                            <template x-if="!detailGood.product">
                                <div class="text-sm text-gray-500">Нет данных о продукте.</div>
                            </template>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-xl p-4">
                            <h3 class="font-semibold text-gray-900 mb-3">Заказ</h3>
                            <template x-if="detailGood.order">
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-600">Название:</span> <span x-text="detailGood.order.name || detailGood.order"></span></div>
                                    <div><span class="text-gray-600">Количество:</span> <span x-text="detailGood.order.quantity"></span></div>
                                    <div><span class="text-gray-600">Статус:</span> <span x-text="detailGood.order.status"></span></div>
                                    <div><span class="text-gray-600">Комментарий:</span> <span x-text="detailGood.order.comment || '-' "></span></div>
                                </div>
                            </template>
                            <template x-if="!detailGood.order">
                                <div class="text-sm text-gray-500">Нет данных о заказе.</div>
                            </template>
                        </div>

                        <template x-if="detailGood.order && detailGood.order.client">
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-gray-900 mb-3">Клиент</h3>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="text-gray-600">Имя:</span> <span x-text="detailGood.order.client.name"></span></div>
                                    <div><span class="text-gray-600">Компания:</span> <span x-text="detailGood.order.client.company || '-' "></span></div>
                                    <div><span class="text-gray-600">Телефон:</span> <span x-text="detailGood.order.client.phone || '-' "></span></div>
                                    <div><span class="text-gray-600">Email:</span> <span x-text="detailGood.order.client.email || '-' "></span></div>
                                </div>
                            </div>
                        </template>

                        <template x-if="detailGood.order && detailGood.order.stages && detailGood.order.stages.length">
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-gray-900 mb-3">Этапы</h3>
                                <ul class="space-y-2 text-sm">
                                    <template x-for="stage in detailGood.order.stages" :key="stage.id">
                                        <li class="flex justify-between">
                                            <span x-text="stage.workshop ? stage.workshop.name : 'Этап'"></span>
                                            <span class="text-gray-500" x-text="stage.date ? new Date(stage.date).toLocaleString('ru-RU') : ''"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>

                        <template x-if="detailGood.order && detailGood.order.defects && detailGood.order.defects.length">
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-gray-900 mb-3">Браки</h3>
                                <ul class="space-y-2 text-sm">
                                    <template x-for="def in detailGood.order.defects" :key="def.id">
                                        <li class="flex justify-between">
                                            <span x-text="def.workshop ? def.workshop.name : 'Брак'"></span>
                                            <span class="text-gray-500" x-text="def.quantity"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    </div>
                </template>
            </aside>
        </div>
        </div>

        <div x-show="activeSection === 'sales'" class="space-y-6">
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Продажи</h2>
                            <p class="text-sm text-gray-500">История продаж готовой продукции.</p>
                        </div>
                        <button @click="fetchSales()" class="text-sm px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50">Обновить</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Продукт</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Кол-во</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Клиент</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Заказ</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Цена</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Дата</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="sale in sales" :key="sale.id">
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-3" x-text="sale.product_name || '-' "></td>
                                        <td class="px-4 py-3" x-text="sale.quantity || '-' "></td>
                                        <td class="px-4 py-3" x-text="sale.client_name || '-' "></td>
                                        <td class="px-4 py-3" x-text="sale.order_name || '-' "></td>
                                        <td class="px-4 py-3" x-text="formatMoney(sale.price)"></td>
                                        <td class="px-4 py-3" x-text="formatDate(sale.sold_at)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="sales.length === 0" class="text-center py-10">
                        <i data-lucide="shopping-cart" class="mx-auto text-gray-400 mb-3" style="width: 40px; height: 40px;"></i>
                        <p class="text-gray-500">Продаж пока нет.</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Оформить продажу</h3>
                    <p class="text-sm text-gray-500 mb-4">Выберите товар со склада, клиента и цену.</p>

                    <form @submit.prevent="submitSale()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Товар со склада</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="saleForm.good_label" readonly placeholder="Товар не выбран" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50">
                                <button type="button" class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50" @click="openPicker('good')">Выбрать</button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Клиент</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="saleForm.client_label" readonly placeholder="Клиент не выбран" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50">
                                <button type="button" class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50" @click="openPicker('client')">Выбрать</button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Заказ (необязательно)</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="saleForm.order_label" readonly placeholder="Без заказа" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50">
                                <button type="button" class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50" @click="openPicker('order')">Выбрать</button>
                                <button type="button" class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50" @click="clearOrder()">Очистить</button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Цена продажи</label>
                            <input type="number" step="0.01" x-model="saleForm.price" placeholder="Введите цену" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div x-show="saleError" class="text-sm text-red-600" x-text="saleError"></div>
                        <div x-show="saleSuccess" class="text-sm text-green-600" x-text="saleSuccess"></div>

                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Оформить продажу</button>
                    </form>
                </div>
            </div>
        </div>

        <div x-show="pickerOpen" class="fixed inset-0 z-50" style="display: none;">
            <div class="absolute inset-0 bg-black bg-opacity-40" @click="closePicker()"></div>
            <div class="fixed right-0 top-0 h-full w-full max-w-lg bg-white shadow-xl p-6 overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900" x-text="pickerTitle"></h3>
                        <p class="text-sm text-gray-500">Введите для поиска и выберите нужный вариант.</p>
                    </div>
                    <button @click="closePicker()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="relative mb-4">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <input type="text" x-model="pickerSearch" @input.debounce.300ms="loadPickerResults()" placeholder="Поиск..." class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <template x-if="pickerLoading">
                    <div class="text-center py-6 text-gray-400">Загрузка...</div>
                </template>
                <template x-if="!pickerLoading">
                    <div class="space-y-2">
                        <template x-for="item in pickerResults" :key="item.id">
                            <button type="button" class="w-full text-left border border-gray-200 rounded-lg px-3 py-2 hover:bg-gray-50" @click="selectPickerItem(item)">
                                <div class="font-medium text-gray-900" x-text="item.title"></div>
                                <div class="text-xs text-gray-500" x-text="item.subtitle"></div>
                            </button>
                        </template>
                        <div x-show="pickerResults.length === 0" class="text-center text-sm text-gray-400 py-6">Ничего не найдено.</div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <script>
        function finishedGoodsData() {
            return {
                goods: [],
                sales: [],
                activeSection: 'stock',
                searchTerm: '',
                sortField: 'received_at',
                sortDirection: 'desc',
                viewMode: 'table',
                saleForm: {
                    finished_good_id: '',
                    good_label: '',
                    client_id: '',
                    client_label: '',
                    order_id: '',
                    order_label: '',
                    price: ''
                },
                saleError: '',
                saleSuccess: '',
                pickerOpen: false,
                pickerType: '',
                pickerTitle: '',
                pickerSearch: '',
                pickerResults: [],
                pickerLoading: false,
                columns: ['product', 'quantity', 'order', 'status_display', 'received_at', 'issued_at', 'recipient', 'comment'],
                columnLabels: {
                    product: 'Продукт',
                    quantity: 'Количество',
                    order: 'Заказ',
                    status_display: 'Статус',
                    received_at: 'Принято',
                    issued_at: 'Выдано',
                    recipient: 'Получатель',
                    comment: 'Комментарий'
                },
                showDetailPanel: false,
                detailGood: null,
                detailLoading: false,
                async fetchGoods() {
                    const resp = await fetch('/finished_goods/api/finished_goods/');
                    const data = await resp.json();
                    this.goods = Array.isArray(data) ? data : (data.results || []);
                },
                async fetchSales() {
                    const resp = await fetch('/finished_goods/api/sales/');
                    const data = await resp.json();
                    this.sales = Array.isArray(data) ? data : (data.results || []);
                },
                stockGoods() {
                    return this.goods.filter(good => good.status === 'stock');
                },
                prepareSale(good) {
                    if (!good || good.status === 'issued') return;
                    this.saleForm.finished_good_id = String(good.id);
                    this.saleForm.good_label = `${this.getProductName(good)} (ID ${good.id})`;
                    this.activeSection = 'sales';
                    this.saleError = '';
                    this.saleSuccess = '';
                },
                clearOrder() {
                    this.saleForm.order_id = '';
                    this.saleForm.order_label = '';
                },
                openPicker(type) {
                    this.pickerType = type;
                    this.pickerTitle = type === 'good' ? 'Выбор товара' : (type === 'client' ? 'Выбор клиента' : 'Выбор заказа');
                    this.pickerSearch = '';
                    this.pickerResults = [];
                    this.pickerOpen = true;
                    this.loadPickerResults();
                    this.$nextTick(() => lucide.createIcons());
                },
                closePicker() {
                    this.pickerOpen = false;
                },
                async loadPickerResults() {
                    const term = this.pickerSearch.trim().toLowerCase();
                    this.pickerLoading = true;
                    if (this.pickerType === 'good') {
                        const goods = this.stockGoods().filter(good => {
                            const name = this.getProductName(good).toLowerCase();
                            return !term || name.includes(term) || String(good.id).includes(term);
                        }).slice(0, 30);
                        this.pickerResults = goods.map(good => ({
                            id: good.id,
                            title: `${this.getProductName(good)} (ID ${good.id})`,
                            subtitle: `Количество: ${good.quantity}`
                        }));
                        this.pickerLoading = false;
                        return;
                    }
                    const baseUrl = this.pickerType === 'client'
                        ? '/clients/api/clients/'
                        : '/orders/api/orders/';
                    const url = `${baseUrl}?search=${encodeURIComponent(term)}&page_size=20`;
                    try {
                        const resp = await fetch(url);
                        const data = await resp.json();
                        const results = Array.isArray(data) ? data : (data.results || []);
                        if (this.pickerType === 'client') {
                            this.pickerResults = results.map(client => ({
                                id: client.id,
                                title: client.name,
                                subtitle: client.company || client.phone || client.email || ''
                            }));
                        } else {
                            this.pickerResults = results.map(order => ({
                                id: order.id,
                                title: order.name,
                                subtitle: order.client && order.client.name ? order.client.name : ''
                            }));
                        }
                    } catch (e) {
                        this.pickerResults = [];
                    }
                    this.pickerLoading = false;
                },
                selectPickerItem(item) {
                    if (this.pickerType === 'good') {
                        this.saleForm.finished_good_id = String(item.id);
                        this.saleForm.good_label = item.title;
                    } else if (this.pickerType === 'client') {
                        this.saleForm.client_id = String(item.id);
                        this.saleForm.client_label = item.title;
                    } else if (this.pickerType === 'order') {
                        this.saleForm.order_id = String(item.id);
                        this.saleForm.order_label = item.title;
                    }
                    this.closePicker();
                },
                async submitSale() {
                    this.saleError = '';
                    this.saleSuccess = '';
                    if (!this.saleForm.finished_good_id || !this.saleForm.client_id || !this.saleForm.price) {
                        this.saleError = 'Заполните товар, клиента и цену.';
                        return;
                    }
                    const payload = {
                        finished_good_id: this.saleForm.finished_good_id,
                        client_id: this.saleForm.client_id,
                        price: this.saleForm.price
                    };
                    if (this.saleForm.order_id) {
                        payload.order_id = this.saleForm.order_id;
                    }
                    const resp = await fetch('/finished_goods/api/sales/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) {
                        this.saleError = 'Не удалось оформить продажу.';
                        return;
                    }
                    this.saleForm = { finished_good_id: '', good_label: '', client_id: '', client_label: '', order_id: '', order_label: '', price: '' };
                    this.saleSuccess = 'Продажа сохранена.';
                    await this.fetchSales();
                    await this.fetchGoods();
                    this.$nextTick(() => lucide.createIcons());
                },
                getProductName(good) {
                    if (!good) return '';
                    if (typeof good.product === 'string') return good.product;
                    return good.product && good.product.name ? good.product.name : '';
                },
                getOrderName(good) {
                    if (!good) return '';
                    if (typeof good.order === 'string') return good.order;
                    return good.order && good.order.name ? good.order.name : '';
                },
                formatDate(value) {
                    if (!value) return '-';
                    try {
                        return new Date(value).toLocaleString('ru-RU');
                    } catch (e) {
                        return '-';
                    }
                },
                formatMoney(value) {
                    if (value === null || value === undefined || value === '') return '-';
                    const amount = Number(value);
                    if (Number.isNaN(amount)) return '-';
                    return `${amount.toLocaleString('ru-RU')} сом`;
                },
                filteredGoods() {
                    const term = this.searchTerm.toLowerCase();
                    let filtered = this.goods.filter(good => {
                        const product = this.getProductName(good).toLowerCase();
                        const order = this.getOrderName(good).toLowerCase();
                        const recipient = (good.recipient || '').toLowerCase();
                        const comment = (good.comment || '').toLowerCase();
                        return product.includes(term) || order.includes(term) || recipient.includes(term) || comment.includes(term);
                    });
                    return filtered.sort((a, b) => {
                        const aValue = this.getSortValue(a, this.sortField);
                        const bValue = this.getSortValue(b, this.sortField);
                        if (typeof aValue === 'string' && typeof bValue === 'string') {
                            return this.sortDirection === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                        }
                        if (typeof aValue === 'number' && typeof bValue === 'number') {
                            return this.sortDirection === 'asc' ? aValue - bValue : bValue - aValue;
                        }
                        return 0;
                    });
                },
                getSortValue(good, field) {
                    if (field === 'product') return this.getProductName(good) || '';
                    if (field === 'order') return this.getOrderName(good) || '';
                    return good[field] || '';
                },
                handleSort(field) {
                    if (this.sortField === field) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        this.sortDirection = 'asc';
                    }
                },
                getCsrfToken() {
                    const name = 'csrftoken';
                    const cookies = document.cookie ? document.cookie.split(';') : [];
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === `${name}=`) {
                            return decodeURIComponent(cookie.substring(name.length + 1));
                        }
                    }
                    return '';
                },
                async init() {
                    await this.fetchGoods();
                    await this.fetchSales();
                    this.$nextTick(() => lucide.createIcons());
                },
                async openDetailPanel(id) {
                    this.showDetailPanel = true;
                    this.detailLoading = true;
                    this.detailGood = null;
                    try {
                        const resp = await fetch(`/finished_goods/api/finished_goods/${id}/`);
                        this.detailGood = await resp.json();
                    } catch (e) {
                        this.detailGood = null;
                    }
                    this.detailLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                },
                closeDetailPanel() {
                    this.showDetailPanel = false;
                    this.detailGood = null;
                    this.detailLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            }
        }
        document.addEventListener('alpine:init', () => {
            Alpine.data('finishedGoodsData', finishedGoodsData);
        });
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>
