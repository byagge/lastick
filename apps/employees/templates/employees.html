<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сотрудники — Управление персоналом</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="min-h-screen bg-slate-50">
    {% include 'partials/app_header.html' %}
    {% include 'partials/app_sidebar.html' %}

    <div class="ml-64 p-8 pt-28" x-data="employeesData()" x-init="init()">
        <!-- Заголовок и действия -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6 flex flex-col lg:flex-row lg:items-center justify-between mb-6">
            <div>
                <h1 class="text-xl lg:text-2xl font-bold text-gray-900 mb-1">Сотрудники</h1>
                <p class="text-gray-600 text-sm">Управление персоналом и зарплатой для администраторов и бухгалтеров</p>
            </div>
            <div class="flex items-center space-x-2 mt-4 lg:mt-0">
                <button @click="viewMode = 'table'" :class="{'text-white': viewMode === 'table', 'text-gray-700 bg-gray-100': viewMode !== 'table'}" class="inline-flex items-center px-3 py-2 rounded-lg text-sm border border-transparent" :style="viewMode === 'table' ? 'background-color:#15181e;' : ''">
                    <i data-lucide="grid-3x3" class="w-4 h-4 mr-1.5"></i>
                    Таблица
                </button>
                <button @click="viewMode = 'cards'" :class="{'text-white': viewMode === 'cards', 'text-gray-700 bg-gray-100': viewMode !== 'cards'}" class="inline-flex items-center px-3 py-2 rounded-lg text-sm border border-transparent" :style="viewMode === 'cards' ? 'background-color:#0e121a;' : ''">
                    <i data-lucide="layout-grid" class="w-4 h-4 mr-1.5"></i>
                    Карточки
                </button>
                <button @click="openAddForm()" class="inline-flex items-center px-4 py-2 text-white rounded-lg text-sm font-medium shadow-sm" style="background-color:#0e121a;">
                    <i data-lucide="user-plus" class="w-4 h-4 mr-1.5"></i>
                    Новый сотрудник
                </button>
            </div>
        </div>

        <!-- Статистика -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 lg:gap-6 mb-6">
            <div class="rounded-xl p-5 flex items-center justify-between text-white shadow-sm" style="background:linear-gradient(135deg,#0e121a,#4b5563);">
                <div>
                    <p class="text-xs uppercase tracking-wide opacity-80">Всего сотрудников</p>
                    <p class="text-2xl font-semibold mt-1" x-text="stats.total_employees"></p>
                    <p class="text-xs mt-1 opacity-80">Включая рабочих и офис</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl p-5 flex items-center justify-between border border-gray-200 shadow-sm">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Средняя эффективность</p>
                    <p class="text-2xl font-semibold text-green-600 mt-1" x-text="stats.average_efficiency + '%'"></p>
                    <p class="text-xs text-gray-500 mt-1">По активным сотрудникам</p>
                </div>
                <i data-lucide="trending-up" class="w-8 h-8 text-green-500"></i>
            </div>
            <div class="bg-white rounded-xl p-5 flex items-center justify-between border border-gray-200 shadow-sm">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Суммарный баланс</p>
                    <p class="text-2xl font-semibold text-blue-600 mt-1" x-text="formatCurrency(stats.total_salary)"></p>
                    <p class="text-xs text-gray-500 mt-1">Текущие начисления</p>
                </div>
                <i data-lucide="wallet-cards" class="w-8 h-8 text-blue-500"></i>
            </div>
            <div class="bg-white rounded-xl p-5 flex items-center justify-between border border-gray-200 shadow-sm">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Активные задачи</p>
                    <p class="text-2xl font-semibold text-purple-600 mt-1" x-text="stats.active_tasks"></p>
                    <p class="text-xs text-gray-500 mt-1">По всем сотрудникам</p>
                </div>
                <i data-lucide="check-square" class="w-8 h-8 text-purple-500"></i>
            </div>
        </div>

        <!-- Фильтры и поиск -->
        <div class="flex flex-col lg:flex-row gap-4 items-center justify-between mb-6">
            <div class="flex items-center space-x-4 w-full lg:w-auto">
                <div class="relative flex-1 lg:flex-none">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    <input type="text" placeholder="Поиск по имени, телефону или email..." x-model="searchTerm" class="pl-10 pr-4 py-2 w-full lg:w-80 border border-gray-200 rounded-lg bg-white focus:outline-none focus:ring-2" style="--tw-ring-color:#0e121a;">
                </div>
                <div class="hidden md:block">
                    <select x-model="roleFilter" class="px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Все роли</option>
                        <option value="worker">Рабочие</option>
                        <option value="admin">Администраторы</option>
                        <option value="accountant">Бухгалтеры</option>
                    </select>
                </div>
                <div class="hidden md:block">
                    <select x-model="workshopFilter" class="px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Все цеха</option>
                        <template x-for="w in workshops" :key="w.id">
                            <option :value="w.id" x-text="w.name"></option>
                        </template>
                    </select>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <template x-if="selectedIds.length > 0">
                    <button @click="bulkDelete()" class="flex items-center space-x-2 px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        <span>Удалить (<span x-text="selectedIds.length"></span>)</span>
                    </button>
                </template>
            </div>
        </div>

        <!-- Табличный вид -->
        <div x-show="viewMode === 'table'" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left w-10">
                                <input type="checkbox"
                                       :checked="selectedIds.length === filteredEmployees().length && filteredEmployees().length > 0"
                                       @change="toggleSelectAll()"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">ФИО</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Роль</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Цех</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Телефон</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Email</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Баланс</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Эффективность</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-900">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="employee in filteredEmployees()" :key="employee.id">
                            <tr :class="{'bg-blue-50': selectedIds.includes(employee.id)}">
                                <td class="px-4 py-3">
                                    <input type="checkbox"
                                           :checked="selectedIds.includes(employee.id)"
                                           @change="toggleSelect(employee.id)"
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </td>
                                <td class="px-4 py-3">
                                    <div class="font-medium text-gray-900" x-text="employee.full_name || employee.name"></div>
                                    <div class="text-xs text-gray-500" x-text="employee.notes"></div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium"
                                          :class="rolePillClass(employee.role)"
                                          x-text="roleLabel(employee)"></span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-700" x-text="employee.workshop_name || '—'"></td>
                                <td class="px-4 py-3 text-sm text-gray-700" x-text="employee.phone || '—'"></td>
                                <td class="px-4 py-3 text-sm text-gray-700" x-text="employee.email || '—'"></td>
                                <td class="px-4 py-3 text-sm font-semibold text-blue-700" x-text="formatCurrency(employee.balance || 0)"></td>
                                <td class="px-4 py-3 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 rounded-full" :class="efficiencyDotClass(employee.efficiency)"></div>
                                        <span class="text-gray-800" x-text="(employee.efficiency || 0) + '%'"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <div class="flex items-center justify-end space-x-2">
                                        <button @click="openDetails(employee)" class="p-1 text-slate-600 hover:text-slate-900" title="Профиль">
                                            <i data-lucide="info" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="openEditForm(employee)" class="p-1 text-blue-600 hover:text-blue-800" title="Редактировать">
                                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="openDeleteConfirm(employee)" class="p-1 text-red-600 hover:text-red-800" title="Удалить">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div x-show="filteredEmployees().length === 0" class="text-center py-12">
                <i data-lucide="users" class="mx-auto text-gray-400 mb-4" style="width: 48px; height: 48px;"></i>
                <p class="text-gray-500 text-lg">Сотрудники не найдены</p>
                <p class="text-gray-400">Попробуйте изменить параметры поиска или фильтры</p>
            </div>
        </div>

        <!-- Карточный вид -->
        <div x-show="viewMode === 'cards'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
            <template x-for="employee in filteredEmployees()" :key="employee.id">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-900" x-text="employee.full_name || employee.name"></h3>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="px-2 py-1 rounded-full text-xs font-medium"
                                      :class="rolePillClass(employee.role)"
                                      x-text="roleLabel(employee)"></span>
                                <span class="text-xs text-gray-500" x-text="employee.workshop_name || 'Без цеха'"></span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="openDetails(employee)" class="p-1 text-slate-600 hover:text-slate-900" title="Профиль">
                                <i data-lucide="info" class="w-4 h-4"></i>
                            </button>
                            <button @click="openEditForm(employee)" class="p-1 text-blue-600 hover:text-blue-800" title="Редактировать">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button @click="openDeleteConfirm(employee)" class="p-1 text-red-600 hover:text-red-800" title="Удалить">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-500 text-xs">Телефон</p>
                            <p class="font-medium text-gray-900" x-text="employee.phone || '—'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs">Email</p>
                            <p class="font-medium text-gray-900 truncate" x-text="employee.email || '—'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs">Тип оплаты</p>
                            <p class="font-medium text-gray-900" x-text="employee.payment_type_display || '—'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs">График</p>
                            <p class="font-medium text-gray-900" x-text="employee.work_schedule_display || '—'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs">Баланс</p>
                            <p class="font-semibold text-blue-700" x-text="formatCurrency(employee.balance || 0)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs">Эффективность</p>
                            <p class="font-semibold text-green-700" x-text="(employee.efficiency || 0) + '%'"></p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-400 flex justify-between">
                        <span x-text="'Создан в системе'"></span>
                        <span></span>
                    </div>
                </div>
            </template>
            <div x-show="filteredEmployees().length === 0" class="col-span-full text-center py-12">
                <i data-lucide="users" class="mx-auto text-gray-400 mb-4" style="width: 48px; height: 48px;"></i>
                <p class="text-gray-500 text-lg">Сотрудники не найдены</p>
                <p class="text-gray-400">Попробуйте изменить параметры поиска или фильтры</p>
            </div>
        </div>

        <!-- Нижняя панель краткой статистики -->
        <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between text-sm text-gray-600">
                <div class="flex items-center space-x-6 mb-2 md:mb-0">
                    <span>Показано: <span x-text="filteredEmployees().length"></span> из <span x-text="employees.length"></span></span>
                    <span>Выбрано: <span x-text="selectedIds.length"></span></span>
                </div>
                <div class="flex items-center space-x-6">
                    <span>Общий баланс: <span x-text="formatCurrency(stats.total_salary)"></span></span>
                    <span class="text-green-600">Средняя эффективность: <span x-text="stats.average_efficiency + '%'"></span></span>
                </div>
            </div>
        </div>

        <!-- Модальная форма (создание/редактирование) -->
        <div x-show="showForm" x-cloak class="fixed inset-0 bg-black bg-opacity-40 flex justify-end z-50"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
            <div class="relative w-full max-w-xl h-full bg-white shadow-2xl border-l border-gray-200 flex flex-col"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="translate-x-0 opacity-100"
                 x-transition:leave-end="translate-x-full opacity-0">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold" x-text="editingEmployee ? 'Редактировать сотрудника' : 'Добавить сотрудника'"></h2>
                                <p class="text-blue-100 text-sm" x-text="editingEmployee ? 'Обновите данные сотрудника' : 'Заполните информацию о новом сотруднике'"></p>
                            </div>
                        </div>
                        <button @click="closeForm()" class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center hover:bg-opacity-30 transition-colors">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <form @submit.prevent="saveEmployee()" class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center space-x-2">
                            <i data-lucide="info" class="w-5 h-5 text-blue-600"></i>
                            <span>Основная информация</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Имя *</label>
                                <input type="text" x-model="formData.first_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Фамилия *</label>
                                <input type="text" x-model="formData.last_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Роль *</label>
                                <select x-model="formData.role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="worker">Рабочий</option>
                                    <option value="admin">Администратор</option>
                                    <option value="accountant">Бухгалтер</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Цех</label>
                                <select x-model="formData.workshop" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">—</option>
                                    <template x-for="w in workshops" :key="w.id">
                                        <option :value="w.id" x-text="w.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Телефон *</label>
                                <input type="tel" x-model="formData.phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" x-model="formData.email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center space-x-2">
                            <i data-lucide="calendar" class="w-5 h-5 text-green-600"></i>
                            <span>HR‑данные</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Тип оплаты</label>
                                <select x-model="formData.payment_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="fixed">Фиксированная</option>
                                    <option value="variable">Сдельная</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">График</label>
                                <select x-model="formData.work_schedule" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="day">Дневной (8-20)</option>
                                    <option value="night">Ночной (20-8)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Дата приёма</label>
                                <input type="date" x-model="formData.employment_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Дата увольнения</label>
                                <input type="date" x-model="formData.dismissal_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Паспорт</label>
                                <input type="text" x-model="formData.passport_number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ИНН</label>
                                <input type="text" x-model="formData.inn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Номер договора</label>
                                <input type="text" x-model="formData.contract_number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Примечания</label>
                            <textarea x-model="formData.notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 pt-6 border-t border-gray-200">
                        <button type="button" @click="closeForm()" class="px-6 py-3 text-gray-700 bg-gray-100 border border-gray-300 rounded-xl hover:bg-gray-200 transition-colors duration-200 flex items-center justify-center space-x-2">
                            <i data-lucide="x" class="w-4 h-4"></i>
                            <span>Отмена</span>
                        </button>
                        <button type="submit" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span x-text="editingEmployee ? 'Обновить' : 'Добавить'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Модальное окно удаления -->
        <div x-show="showDeleteModal" x-cloak class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 relative">
                <button @click="showDeleteModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                    </div>
                    <h2 class="text-xl font-bold text-red-700">Удалить сотрудника?</h2>
                </div>
                <p class="mb-6 text-gray-700" x-text="deleteTarget ? 'Вы действительно хотите удалить ' + (deleteTarget.full_name || deleteTarget.name) + '?' : 'Вы действительно хотите удалить выбранных сотрудников?'"></p>
                <div class="flex justify-end space-x-2">
                    <button @click="showDeleteModal = false" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded">Отмена</button>
                    <button @click="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded">Удалить</button>
                </div>
            </div>
        </div>

        <!-- Панель деталей сотрудника -->
        <div x-show="showDetailsPanel" x-cloak class="fixed inset-0 bg-black bg-opacity-30 flex justify-end z-40"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
            <div class="w-full max-w-md h-full bg-white shadow-xl border-l border-gray-200 flex flex-col"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="translate-x-0 opacity-100"
                 x-transition:leave-end="translate-x-full opacity-0">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide">Профиль сотрудника</p>
                        <h3 class="text-lg font-semibold text-gray-900" x-text="detailsEmployee?.full_name || detailsEmployee?.name || 'Сотрудник'"></h3>
                    </div>
                    <button @click="closeDetails()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 space-y-4" x-show="detailsEmployee">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-lg font-bold">
                            <span x-text="initials(detailsEmployee.full_name || detailsEmployee.name)"></span>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium" :class="rolePillClass(detailsEmployee.role)" x-text="roleLabel(detailsEmployee)"></span>
                                <span class="text-xs text-gray-500" x-text="detailsEmployee.workshop_name || 'Без цеха'"></span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1" x-text="detailsEmployee.employment_date ? 'Работает с ' + detailsEmployee.employment_date : 'Дата приёма не указана'"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Телефон</p>
                            <p class="font-medium text-gray-900" x-text="detailsEmployee.phone || '—'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Email</p>
                            <p class="font-medium text-gray-900 break-all" x-text="detailsEmployee.email || '—'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Тип оплаты</p>
                            <p class="font-medium text-gray-900" x-text="detailsEmployee.payment_type_display || '—'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">График</p>
                            <p class="font-medium text-gray-900" x-text="detailsEmployee.work_schedule_display || '—'"></p>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Примечания</p>
                        <p class="text-sm text-gray-800 whitespace-pre-line" x-text="detailsEmployee.notes || 'Примечания отсутствуют'"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-green-50 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-green-700" x-text="detailsEmployee.completed_works || 0"></div>
                            <div class="text-xs text-green-600">Выполнено работ</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-red-700" x-text="detailsEmployee.defects || 0"></div>
                            <div class="text-xs text-red-600">Браков</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-blue-700" x-text="formatCurrency(detailsEmployee.monthly_salary || 0)"></div>
                            <div class="text-xs text-blue-600">Заработок за месяц</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-purple-700" x-text="(detailsEmployee.efficiency || 0) + '%'"></div>
                            <div class="text-xs text-purple-600">Эффективность</div>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-200 px-6 py-3 flex justify-end space-x-2 bg-gray-50">
                    <button @click="openDeleteConfirm(detailsEmployee)" class="px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 flex items-center space-x-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        <span>Удалить</span>
                    </button>
                    <button @click="closeDetails()" class="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    function employeesData() {
        return {
            employees: [],
            workshops: [],
            stats: { total_employees: 0, average_efficiency: 0, total_salary: 0, active_tasks: 0 },
            searchTerm: '',
            roleFilter: '',
            workshopFilter: '',
            viewMode: 'table',
            selectedIds: [],
            showForm: false,
            editingEmployee: null,
            showDeleteModal: false,
            deleteTarget: null,
            showDetailsPanel: false,
            detailsEmployee: null,
            formData: {
                first_name: '',
                last_name: '',
                role: 'worker',
                phone: '',
                email: '',
                workshop: '',
                notes: '',
                payment_type: 'fixed',
                work_schedule: 'day'
            },
            async init() {
                await Promise.all([
                    this.loadEmployees(),
                    this.loadStats(),
                    this.loadWorkshops()
                ]);
                this.$nextTick(() => lucide.createIcons());
            },
            async loadEmployees() {
                try {
                    const response = await fetch('/employees/api/employees/');
                    const data = await response.json();
                    this.employees = Array.isArray(data) ? data : (data.results || data.employees || []);
                } catch (e) {
                    console.error('Ошибка загрузки сотрудников:', e);
                    this.employees = [];
                }
            },
            async loadStats() {
                try {
                    const response = await fetch('/employees/api/employees/stats/');
                    if (response.ok) {
                        this.stats = await response.json();
                    }
                } catch (e) {
                    console.error('Ошибка загрузки статистики сотрудников:', e);
                }
            },
            async loadWorkshops() {
                try {
                    const response = await fetch('/workshops/api/workshops/');
                    const data = await response.json();
                    this.workshops = Array.isArray(data) ? data : (data.results || data.workshops || []);
                } catch (e) {
                    console.error('Ошибка загрузки цехов:', e);
                    this.workshops = [];
                }
            },
            filteredEmployees() {
                let list = this.employees || [];
                const search = (this.searchTerm || '').toLowerCase();
                return list.filter(e => {
                    if (!e) return false;
                    if (this.roleFilter && e.role !== this.roleFilter) return false;
                    if (this.workshopFilter && String(e.workshop) !== String(this.workshopFilter)) return false;
                    if (!search) return true;
                    const name = (e.full_name || e.name || '').toLowerCase();
                    const phone = (e.phone || '');
                    const email = (e.email || '').toLowerCase();
                    return name.includes(search) || phone.includes(this.searchTerm) || email.includes(search);
                });
            },
            toggleSelect(id) {
                if (this.selectedIds.includes(id)) {
                    this.selectedIds = this.selectedIds.filter(v => v !== id);
                } else {
                    this.selectedIds.push(id);
                }
            },
            toggleSelectAll() {
                const current = this.filteredEmployees().map(e => e.id);
                if (this.selectedIds.length === current.length) {
                    this.selectedIds = [];
                } else {
                    this.selectedIds = current;
                }
            },
            roleLabel(employee) {
                return employee.role_display || employee.position || employee.role || 'Сотрудник';
            },
            rolePillClass(role) {
                if (role === 'admin') return 'bg-purple-100 text-purple-800';
                if (role === 'accountant') return 'bg-yellow-100 text-yellow-800';
                return 'bg-green-100 text-green-800';
            },
            efficiencyDotClass(value) {
                const eff = Number(value) || 0;
                if (eff >= 90) return 'bg-green-500';
                if (eff >= 75) return 'bg-blue-500';
                if (eff >= 60) return 'bg-yellow-500';
                return 'bg-red-500';
            },
            formatCurrency(value) {
                const num = Number(value) || 0;
                return new Intl.NumberFormat('ru-RU', {
                    maximumFractionDigits: 0
                }).format(num) + ' сом';
            },
            openAddForm() {
                this.editingEmployee = null;
                this.formData = {
                    first_name: '',
                    last_name: '',
                    role: 'worker',
                    phone: '',
                    email: '',
                    workshop: '',
                    notes: '',
                    payment_type: 'fixed',
                    work_schedule: 'day'
                };
                this.showForm = true;
                this.$nextTick(() => lucide.createIcons());
            },
            openEditForm(employee) {
                this.editingEmployee = employee;
                this.formData = {
                    first_name: employee.first_name || '',
                    last_name: employee.last_name || '',
                    role: employee.role || 'worker',
                    phone: employee.phone || '',
                    email: employee.email || '',
                    workshop: employee.workshop || '',
                    notes: employee.notes || '',
                    payment_type: employee.payment_type || 'fixed',
                    work_schedule: employee.work_schedule || 'day'
                };
                this.showForm = true;
                this.$nextTick(() => lucide.createIcons());
            },
            closeForm() {
                this.showForm = false;
                this.editingEmployee = null;
            },
            async saveEmployee() {
                if (!this.formData.first_name || !this.formData.last_name || !this.formData.phone || !this.formData.email) {
                    alert('Пожалуйста, заполните обязательные поля');
                    return;
                }
                const payload = { ...this.formData };
                try {
                    let url = '/employees/api/employees/';
                    let method = 'POST';
                    if (this.editingEmployee) {
                        url = `/employees/api/employees/${this.editingEmployee.id}/`;
                        method = 'PUT';
                    }
                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(payload),
                        credentials: 'include'
                    });
                    if (response.ok) {
                        this.closeForm();
                        await this.loadEmployees();
                        await this.loadStats();
                    } else {
                        const data = await response.json();
                        alert('Ошибка: ' + (data.detail || JSON.stringify(data)));
                    }
                } catch (e) {
                    console.error('Ошибка сохранения сотрудника:', e);
                    alert('Ошибка сохранения сотрудника');
                }
            },
            openDeleteConfirm(employee) {
                this.deleteTarget = employee;
                this.showDeleteModal = true;
            },
            async confirmDelete() {
                try {
                    if (this.deleteTarget) {
                        const response = await fetch(`/employees/api/employees/${this.deleteTarget.id}/`, {
                            method: 'DELETE',
                            headers: { 'X-CSRFToken': this.getCsrfToken() },
                            credentials: 'include'
                        });
                        if (!response.ok) {
                            const data = await response.json();
                            alert('Ошибка удаления: ' + (data.detail || JSON.stringify(data)));
                            return;
                        }
                    } else if (this.selectedIds.length > 0) {
                        for (const id of this.selectedIds) {
                            await fetch(`/employees/api/employees/${id}/`, {
                                method: 'DELETE',
                                headers: { 'X-CSRFToken': this.getCsrfToken() },
                                credentials: 'include'
                            });
                        }
                    }
                    this.showDeleteModal = false;
                    this.deleteTarget = null;
                    this.selectedIds = [];
                    await this.loadEmployees();
                    await this.loadStats();
                } catch (e) {
                    console.error('Ошибка удаления сотрудника:', e);
                    alert('Ошибка удаления сотрудника');
                }
            },
            async bulkDelete() {
                this.deleteTarget = null;
                this.showDeleteModal = true;
            },
            openDetails(employee) {
                this.detailsEmployee = employee;
                this.showDetailsPanel = true;
                this.$nextTick(() => lucide.createIcons());
            },
            closeDetails() {
                this.showDetailsPanel = false;
                this.detailsEmployee = null;
            },
            getCsrfToken() {
                const name = 'csrftoken';
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
                return '';
            },
            initials(name) {
                if (!name) return '';
                return name.split(' ').map(w => w[0]).join('').toUpperCase().substring(0, 2);
            }
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
    </script>
</body>
</html>

